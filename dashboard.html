<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmartSched | Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';</script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.4.21/mammoth.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        /* --- CSS STYLES --- */
        :root {
            --primary: #4F46E5;
            --secondary: #E0E7FF;
            --dark: #1F2937;
            --light: #F3F4F6;
            --white: #ffffff;
            --success: #10B981;
            --urgent: #EF4444;
        }

        /* Dark Mode */
        body.dark-mode { --light: #111827; --white: #1F2937; --dark: #F9FAFB; --secondary: #374151; }
        body.dark-mode .task-title { color: #F3F4F6; }
        body.dark-mode .task-subject { color: #9CA3AF; }
        body.dark-mode input, body.dark-mode select { background-color: #374151; color: white; border-color: #4B5563; }
        body.dark-mode .modal-content { background-color: #1F2937; color: white; }
        body.dark-mode .sidebar { border-right-color: #374151; background-color: #1F2937; }
        body.dark-mode .timer-card { background: #374151 !important; border-color: #4B5563 !important; }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
        body { display: flex; height: 100vh; background-color: var(--light); color: var(--dark); transition: background-color 0.3s; }

        .sidebar { width: 250px; background-color: var(--white); border-right: 1px solid #e5e7eb; display: flex; flex-direction: column; padding: 20px; transition: 0.3s; z-index: 1000; }
        .logo { font-size: 1.5rem; font-weight: 700; color: var(--primary); margin-bottom: 40px; display: flex; align-items: center; gap: 10px; }

        .nav-item { padding: 12px 15px; margin-bottom: 10px; border-radius: 8px; cursor: pointer; color: #6B7280; font-weight: 500; transition: all 0.3s; display: flex; align-items: center; gap: 10px; }
        .nav-item:hover, .nav-item.active { background-color: var(--secondary); color: var(--primary); }

        .main-content { flex: 1; padding: 40px; overflow-y: auto; }
        .header { margin-bottom: 30px; }
        .header h1 { font-size: 1.8rem; margin-bottom: 5px; }
        .header p { color: #6B7280; }

        .view-section { display: none; animation: fadeIn 0.4s ease; }
        .view-section.active { display: block; }

        .upload-zone { border: 2px dashed #9CA3AF; border-radius: 12px; padding: 50px; text-align: center; background-color: var(--white); transition: 0.3s; cursor: pointer; }
        .upload-zone:hover { border-color: var(--primary); background-color: #F9FAFB; }
        body.dark-mode .upload-zone:hover { background-color: #374151; }
        .upload-icon { font-size: 3rem; color: #9CA3AF; margin-bottom: 15px; }

        .btn-primary { background-color: var(--primary); color: white; border: none; padding: 12px 24px; border-radius: 8px; font-size: 1rem; cursor: pointer; margin-top: 20px; transition: 0.2s; }
        .btn-primary:hover { background-color: #4338ca; }

        .schedule-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 20px; margin-top: 20px; }

        /* --- CARD STYLES --- */
        .task-card {
            background: var(--white); padding: 20px; border-radius: 16px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); border-left: 6px solid var(--primary);
            position: relative; transition: 0.3s; display: flex; flex-direction: column; min-height: 220px;
        }
        .task-card:hover { transform: translateY(-4px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        .task-card.Urgent { border-left-color: #EF4444; }
        .task-card.Medium { border-left-color: #F59E0B; }

        .task-content { flex-grow: 1; display: flex; flex-direction: column; margin-bottom: 15px; }
        .task-title { font-weight: 700; font-size: 1.15rem; margin-bottom: 8px; padding-right: 40px; line-height: 1.3; color: #111827; }
        .task-subject { color: #6B7280; font-size: 0.9rem; margin-bottom: auto; }
        .task-date { margin-top: 10px; font-size: 0.85rem; color: #4F46E5; font-weight: 600; display: inline-flex; align-items: center; gap: 6px; background: #EEF2FF; padding: 6px 12px; border-radius: 20px; align-self: flex-start; }

        .smart-links { display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap; }

        .card-actions {
            display: flex; gap: 10px; margin-top: auto; padding-top: 15px;
            border-top: 1px solid #F3F4F6;
        }
        body.dark-mode .card-actions { border-top-color: #374151; }

        .calendar-btn {
            display: flex; align-items: center; justify-content: center; flex: 2;
            padding: 10px; background-color: #4F46E5; color: white !important;
            border-radius: 8px; text-decoration: none; font-size: 0.9rem; font-weight: 600;
            cursor: pointer; transition: 0.2s; box-shadow: 0 2px 4px rgba(79, 70, 229, 0.2);
        }
        .calendar-btn:hover { background-color: #4338ca; transform: translateY(-1px); }

        .check-btn-inline {
            display: flex; align-items: center; justify-content: center; width: 42px; height: 42px;
            background-color: #D1FAE5; color: #10B981; border: 1px solid #A7F3D0;
            border-radius: 8px; cursor: pointer; transition: 0.2s;
        }
        .check-btn-inline:hover { background-color: #10B981; color: white; }

        .delete-btn-inline {
            display: flex; align-items: center; justify-content: center; width: 42px; height: 42px;
            background-color: #FEF2F2; color: #EF4444; border: 1px solid #FECACA;
            border-radius: 8px; cursor: pointer; transition: 0.2s;
        }
        .delete-btn-inline:hover { background-color: #EF4444; color: white; border-color: #EF4444; }

        .edit-btn-corner {
            position: absolute; top: 15px; right: 15px; width: 32px; height: 32px;
            border-radius: 50%; background: #fff; border: 1px solid #E5E7EB; color: #9CA3AF;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; transition: all 0.2s; z-index: 10;
        }
        .edit-btn-corner:hover { background: #F3F4F6; color: #4F46E5; border-color: #C7D2FE; }

        .task-card.completed-card { opacity: 0.6; background-color: #f9fafb; border-left: 5px solid #9CA3AF !important; }
        .task-card.completed-card .task-title { text-decoration: line-through; }

        /* Modal & Loader */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 2000; justify-content: center; align-items: center; backdrop-filter: blur(3px); }
        .modal-content { background: white; padding: 30px; border-radius: 16px; width: 90%; max-width: 400px; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); }
        .loader-container { display: none; text-align: center; margin-top: 50px; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid var(--primary); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 15px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .toast { position: fixed; bottom: 20px; right: 20px; background: #4F46E5; color: white; padding: 14px 20px; border-radius: 8px; box-shadow: 0 10px 20px rgba(0,0,0,0.15); opacity: 0; transform: translateY(20px); transition: all 0.3s ease; z-index: 2000; font-size: 0.9rem; }
        .toast.show { opacity: 1; transform: translateY(0); }

        /* --- MOBILE RESPONSIVENESS OVERRIDES --- */
        .hamburger { display: none; position: fixed; top: 20px; left: 20px; font-size: 1.8rem; cursor: pointer; z-index: 3000; background: white; padding: 8px 12px; border-radius: 8px; box-shadow: 0 5px 10px rgba(0,0,0,0.15); }

        @media (max-width: 768px) {
            body { flex-direction: column; }
            .hamburger { display: block; }
            .sidebar { position: fixed; left: -260px; top: 0; height: 100%; transition: left 0.3s ease; z-index: 2000; background: white; box-shadow: 2px 0 5px rgba(0,0,0,0.1); }
            .sidebar.open { left: 0; }
            .main-content { padding: 80px 20px 20px 20px; }
            .schedule-grid { grid-template-columns: 1fr; }
        }

        /* --- KAHOOT STYLE QUIZ MODAL --- */
        .quiz-modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(17, 24, 39, 0.95); z-index: 3000; justify-content: center; align-items: center;
        }
        .quiz-content {
            background: #46178F; width: 90%; max-width: 600px; border-radius: 20px; padding: 30px;
            color: white; text-align: center; box-shadow: 0 20px 25px rgba(0,0,0,0.5); border: 4px solid rgba(255,255,255,0.1);
        }
        .quiz-header { font-size: 1.8rem; font-weight: 900; margin-bottom: 20px; text-shadow: 2px 2px 0px rgba(0,0,0,0.2); }
        .quiz-question { background: white; color: #333; padding: 20px; border-radius: 12px; font-weight: 700; font-size: 1.2rem; margin-bottom: 30px; }
        .quiz-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        @media (max-width: 480px) { .quiz-grid { grid-template-columns: 1fr; } }
        .quiz-btn { padding: 20px; border: none; border-radius: 8px; color: white; font-weight: 700; font-size: 1.1rem; cursor: pointer; transition: transform 0.1s; box-shadow: 0 4px 0 rgba(0,0,0,0.2); }
        .quiz-btn:active { transform: translateY(4px); box-shadow: none; }
        .q-red { background: #E21B3C; } .q-blue { background: #1368CE; } .q-yellow { background: #D89E00; } .q-green { background: #26890C; }
        .close-quiz { margin-top: 20px; background: transparent; border: 2px solid rgba(255,255,255,0.3); color: white; padding: 10px 20px; border-radius: 20px; cursor: pointer; }

        .supported-icons { display: flex; gap: 15px; justify-content: center; margin-top: 20px; opacity: 0.7; }
        .icon-box { display: flex; flex-direction: column; align-items: center; font-size: 0.8rem; color: #6B7280; }
        .icon-box i { font-size: 1.5rem; margin-bottom: 5px; }

        .flash-correct { animation: flashGreen 1s ease; }
        .flash-wrong { animation: flashRed 1s ease; }
        @keyframes flashGreen { 0%, 100% { background-color: #46178F; } 50% { background-color: #26890C; } }
        @keyframes flashRed { 
            0%, 100% { background-color: #46178F; transform: translateX(0); } 
            20%, 60% { transform: translateX(-10px); } 
            40%, 80% { transform: translateX(10px); } 
            50% { background-color: #E21B3C; } 
        }
    </style>
</head>
<body>
<div class="hamburger" onclick="toggleSidebar()">‚ò∞</div>

<div class="sidebar">
    <div class="logo">
        <img src="Logo.png" alt="Logo" style="height: 40px; width: auto;">
        SmartSched
    </div>

    <div class="nav-item active" onclick="switchTab('dashboard')" role="button" tabindex="0">
        <i class="fa-solid fa-chart-pie"></i> Dashboard
    </div>
    <div class="nav-item" onclick="switchTab('upload')" role="button" tabindex="0">
        <i class="fa-solid fa-file-upload"></i> Upload Syllabus
    </div>
    <div class="nav-item" onclick="switchTab('schedule')" role="button" tabindex="0">
        <i class="fa-solid fa-calendar-days"></i> My Schedule
    </div>
    <div class="nav-item" onclick="openQuiz()" style="color: #4F46E5; background: #EEF2FF; font-weight: 700;">
        <i class="fa-solid fa-gamepad"></i> Study Mode
    </div>

    <div class="timer-card" style="margin-top: 20px; padding: 15px; background: #f9fafb; border-radius: 12px; border: 1px solid #e5e7eb; text-align: center;">
        <p style="font-size: 0.7rem; font-weight: 700; color: #6B7280; text-transform: uppercase; margin-bottom: 8px;">Pomodoro</p>
        <div id="timer-display" style="font-size: 1.6rem; font-weight: 700; color: #4F46E5; margin-bottom: 10px;">25:00</div>
        <div style="display: flex; gap: 8px; justify-content: center;">
            <button onclick="startTimer()" style="background:#4F46E5; color:white; border:none; padding:8px; border-radius:6px; cursor:pointer; width:35px;"><i class="fa-solid fa-play"></i></button>
            <button onclick="pauseTimer()" style="background:#9CA3AF; color:white; border:none; padding:8px; border-radius:6px; cursor:pointer; width:35px;"><i class="fa-solid fa-pause"></i></button>
            <button onclick="resetTimer()" style="background:#fff; color:#4F46E5; border:1px solid #E5E7EB; padding:8px; border-radius:6px; cursor:pointer; width:35px;"><i class="fa-solid fa-rotate-right"></i></button>
        </div>
    </div>

    <div class="nav-item" onclick="toggleDarkMode()" style="margin-top: auto;"><i class="fa-solid fa-moon"></i> Dark Mode</div>
    <div class="nav-item" id="logoutBtn" style="color: #EF4444;"><i class="fa-solid fa-sign-out-alt"></i> Log Out</div>
</div>

<div class="main-content">
    <div id="dashboard" class="view-section active">
        <div class="header"><h1>Hello, Student! üëã</h1><p>Here is your academic overview.</p></div>
        <div style="display: flex; gap: 20px; flex-wrap: wrap;">
            <div class="task-card" style="flex: 1; border-left-color: var(--success); min-height: 150px;"><h3>Total Tasks</h3><h1 style="font-size: 2.5rem; margin: 10px 0;" id="total-count">0</h1><p style="color: #6B7280;">Saved in Database</p></div>
            <div class="task-card" style="flex: 1; border-left-color: #F59E0B; min-height: 150px;"><h3>Upcoming</h3><h1 style="font-size: 2.5rem; margin: 10px 0;" id="upcoming-count">0</h1><p style="color: #6B7280;">Deadlines</p></div>
            <div class="task-card" style="flex: 1; border-left-color: #EF4444; min-height: 150px;"><h3>Urgent</h3><h1 style="font-size: 2.5rem; margin: 10px 0;" id="urgent-count">0</h1><p style="color: #6B7280;">High Priority</p></div>
        </div>
    </div>

    <div id="upload" class="view-section">
        <div class="header"><h1>Upload Syllabus</h1><p>Upload your course material. Our AI will extract the deadlines.</p></div>

        <div class="upload-zone" onclick="triggerFileInput()" role="button" tabindex="0">
            <i class="fa-solid fa-cloud-arrow-up upload-icon"></i>
            <h3>Drag & Drop your Syllabus here</h3>
            <p style="color: #9CA3AF; margin-top: 10px;">or click to browse files</p>
            <input type="file" id="fileInput" accept=".pdf, .docx, .pptx" style="display: none;" onchange="handleFileSelect()">
        </div>
        <div class="loader-container" id="aiLoader"><div class="spinner"></div><h3>Analyzing...</h3></div>
        <button class="btn-primary" id="processBtn" style="display: none;" onclick="processSyllabus()">Generate Study Plan</button>
        <div class="supported-icons">
            <div class="icon-box"><i class="fa-solid fa-file-pdf" style="color: #EF4444;"></i> PDF</div>
            <div class="icon-box"><i class="fa-solid fa-file-word" style="color: #2563EB;"></i> Word</div>
            <div class="icon-box"><i class="fa-solid fa-file-powerpoint" style="color: #EA580C;"></i> PPT</div>
        </div>
    </div>

    <div id="schedule" class="view-section">
        <div class="header"><h1>Your Study Plan</h1><p>AI-generated schedule based on your uploads.</p></div>
        <div class="schedule-grid" id="taskList"></div>
        <h2 style="margin-top:40px;">Completed Tasks</h2>
        <div class="schedule-grid" id="completedTaskList"></div>
    </div>
</div>

<div id="quizModal" class="quiz-modal">
    <div class="quiz-content">
        <div class="quiz-header">Study Mode üöÄ</div>
        <div id="quiz-question" class="quiz-question">Choose how you want to study:</div>
        <div id="quiz-options" class="quiz-grid">
            <button class="quiz-btn q-blue" onclick="startQuickQuiz()">Quick Quiz (From Tasks)</button>
            <button class="quiz-btn q-green" onclick="document.getElementById('materialInput').click()">Upload Materials</button>
        </div>
        <input type="file" id="materialInput" accept=".pdf, .docx, .pptx" style="display: none;" onchange="handleMaterialUpload()">
        <div class="loader-container" id="quizLoader" style="margin-top: 20px;">
            <div class="spinner" style="border-top-color: white;"></div>
            <h3 style="color: white;">Reading materials & building quiz...</h3>
        </div>
        <button class="close-quiz" onclick="closeQuiz()">Exit Game</button>
    </div>
</div>

<div id="editModal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header" style="font-weight:bold; margin-bottom:15px; font-size:1.2rem;">Edit Task Details</div>
        <div class="form-group" style="margin-bottom:10px;"><label>Title</label><input type="text" id="editTitle" style="width:100%; padding:8px;"></div>
        <div class="form-group" style="margin-bottom:10px;"><label>Subject</label><input type="text" id="editSubject" style="width:100%; padding:8px;"></div>
        <div class="form-group" style="margin-bottom:10px;"><label>Due Date</label><input type="date" id="editDate" style="width:100%; padding:8px;"></div>
        <div class="form-group" style="margin-bottom:15px;"><label>Priority</label><select id="editPriority" style="width:100%; padding:8px;"><option value="Normal">Normal</option><option value="Medium">Medium</option><option value="Urgent">Urgent</option></select></div>
        <div class="modal-actions" style="display:flex; gap:10px;">
            <button class="btn-cancel" style="background:#E5E7EB; padding:10px; border-radius:6px; border:none; cursor:pointer; flex:1;" onclick="closeEditModal()">Cancel</button>
            <button class="btn-save" style="background:#4F46E5; color:white; padding:10px; border-radius:6px; border:none; cursor:pointer; flex:1;" onclick="saveEditTask()">Save Changes</button>
        </div>
    </div>
</div>

<div id="materialModal" class="modal-overlay">
    <div class="modal-content" style="max-width: 600px; max-height: 80vh; display: flex; flex-direction: column;">
        <div class="modal-header" style="font-weight:bold; margin-bottom:15px; font-size:1.2rem; display: flex; justify-content: space-between;">
            <span>Study Material</span>
            <i class="fa-solid fa-xmark" style="cursor:pointer;" onclick="closeMaterialModal()"></i>
        </div>
        <div id="materialContent" style="flex: 1; overflow-y: auto; padding: 20px; background: #ffffff; border-radius: 8px; font-size: 1rem; color: #374151; border: 1px solid #E5E7EB; line-height: 1.6;">
            Loading...
        </div>
    </div>
</div>

<div id="toast" class="toast"></div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, query, where, deleteDoc, updateDoc, doc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBol-uWE7KCF_ESsd7QvsIVZ9KiBWcyN4c",
        authDomain: "smartsched-452d3.firebaseapp.com",
        projectId: "smartsched-452d3",
        storageBucket: "smartsched-452d3.firebasestorage.app",
        messagingSenderId: "623006049130",
        appId: "1:623006049130:web:a9610ea2c1e401098c7b13",
        measurementId: "G-833N678XPR"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    const GEMINI_API_KEY = atob("QUl6YVN5QmtLb0FJMm1hYTZaQzJiczdpZzZMX0VER2d0ZFlMZ0dN");

    let currentUser = null;
    let selectedFile = null;
    let globalTasks = [];
    let editingTaskId = null;

    onAuthStateChanged(auth, (user) => {
        if (user) { currentUser = user; loadTasksFromFirestore(); }
        else { window.location.href = "index.html"; }
    });

    document.getElementById('logoutBtn').onclick = () => {
        Swal.fire({
            title: 'Log out?', text: "You will be returned to the login screen.", icon: 'warning',
            showCancelButton: true, confirmButtonColor: '#EF4444', confirmButtonText: 'Yes, log out'
        }).then((result) => { if (result.isConfirmed) signOut(auth).then(() => window.location.href = "index.html"); });
    };

    window.toggleDarkMode = () => document.body.classList.toggle('dark-mode');
    window.switchTab = (tabId) => {
        document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
        document.querySelectorAll('.view-section').forEach(s => s.classList.remove('active'));
        const activeNav = Array.from(document.querySelectorAll('.nav-item')).find(nav => nav.innerText.toLowerCase().includes(tabId));
        if(activeNav) activeNav.classList.add('active');
        document.getElementById(tabId).classList.add('active');
        document.querySelector('.sidebar').classList.remove('open');
    }
    window.triggerFileInput = () => document.getElementById('fileInput').click();
    window.handleFileSelect = () => {
        const f = document.getElementById('fileInput');
        if(f.files.length > 0) {
            selectedFile = f.files[0];
            document.querySelector('.upload-zone h3').innerText = "File Selected: " + selectedFile.name;
            document.getElementById('processBtn').style.display = "inline-block";
        }
    }

    // --- BACKEND LOGIC: SYLLABUS PROCESSOR ---
    window.processSyllabus = async function() {
        if (!selectedFile) return;
        document.querySelector('.upload-zone').style.display = 'none';
        document.getElementById('processBtn').style.display = 'none';
        document.getElementById('aiLoader').style.display = 'block';

        try {
            let text = "";
            const fileName = selectedFile.name.toLowerCase();
            if (fileName.endsWith('.pdf')) text = await extractTextFromPDF(selectedFile);
            else if (fileName.endsWith('.docx')) text = await extractTextFromWord(selectedFile);
            else if (fileName.endsWith('.pptx')) text = await extractTextFromPPTX(selectedFile);
            else throw new Error("Unsupported file type!");

            const tasks = await analyzeWithGemini(text, GEMINI_API_KEY);
            await saveTasksToFirestore(tasks, text);

            document.getElementById('aiLoader').style.display = 'none';
            switchTab('schedule');
            resetUpload();
            showToast(`Saved ${tasks.length} tasks!`);
        } catch (error) {
            console.error(error);
            showToast(error.message, "error");
            document.getElementById('aiLoader').style.display = 'none';
            resetUpload();
        }
    }

    async function extractTextFromPDF(file) {
        const ab = await file.arrayBuffer();
        const pdf = await pdfjsLib.getDocument(ab).promise;
        let fullText = "";
        for (let i = 1; i <= pdf.numPages; i++) {
            const p = await pdf.getPage(i);
            const t = await p.getTextContent();
            fullText += t.items.map(s => s.str).join(" ") + "\n";
        }
        return fullText;
    }

    async function extractTextFromWord(file) {
        const arrayBuffer = await file.arrayBuffer();
        const result = await mammoth.extractRawText({ arrayBuffer: arrayBuffer });
        return result.value;
    }

    async function extractTextFromPPTX(file) {
        const zip = new JSZip();
        const zipContent = await zip.loadAsync(file);
        let fullText = "";
        for (const relativePath in zipContent.files) {
            if (relativePath.startsWith("ppt/slides/slide") && relativePath.endsWith(".xml")) {
                const xmlText = await zipContent.file(relativePath).async("string");
                const matches = xmlText.match(/<a:t>(.*?)<\/a:t>/g);
                if (matches) {
                    fullText += matches.map(m => m.replace(/<\/?a:t>/g, '')).join(" ") + "\n";
                }
            }
        }
        return fullText;
    }

    async function analyzeWithGemini(text, apiKey) {
        const prompt = `Analyze this syllabus text. Extract assignments/exams. Return JSON: [{"title": "Task", "subject": "Course", "date": "YYYY-MM-DD", "priority": "Urgent/Medium/Normal", "subtasks": ["Step 1"], "estimated_time": "2 hours"}] Text: ${text.substring(0, 10000)}`;
        const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${apiKey}`;
        
        try {
            const res = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
            });
            
            const data = await res.json();

            // THE SHIELD: If Google rejects it, print the RAW error so we can read it!
            if (!res.ok || !data.candidates) {
                console.error("üö® GOOGLE'S RAW ERROR:", data);
                throw new Error(data.error?.message || "Google rejected the API key or request.");
            }

            return JSON.parse(data.candidates[0].content.parts[0].text.replace(/```json|```/g, '').trim());
            
        } catch (error) {
            console.error("Caught Error:", error);
            throw error; // This sends the real error to your SweetAlert popup
        }
    }

    async function saveTasksToFirestore(tasks, rawText = "") {
        if(!currentUser) return;
        const promises = tasks.map(t => addDoc(collection(db, "tasks"), {
            ...t,
            completed: false,
            userId: currentUser.uid,
            originalText: rawText,
            createdAt: new Date()
        }));
        await Promise.all(promises);
        await loadTasksFromFirestore();
    }

    async function loadTasksFromFirestore() {
        if(!currentUser) return;
        const q = query(collection(db, "tasks"), where("userId", "==", currentUser.uid));
        const snap = await getDocs(q);
        globalTasks = [];
        snap.forEach((doc) => globalTasks.push({ id: doc.id, ...doc.data() }));
        renderTasks(globalTasks);
    }

    // --- TASK: RENDER TASKS WITH EMPTY STATES ---
    function renderTasks(tasks) {
        const activeList = document.getElementById('taskList');
        const completedList = document.getElementById('completedTaskList');
        const active = tasks.filter(t => !t.completed);
        const completed = tasks.filter(t => t.completed);

        document.getElementById('total-count').innerText = tasks.length;
        document.getElementById('upcoming-count').innerText = active.length;
        document.getElementById('urgent-count').innerText = active.filter(t => t.priority === 'Urgent').length;

        if (active.length === 0) {
            activeList.innerHTML = `
            <div style="grid-column: 1/-1; text-align: center; color: #9CA3AF; padding: 60px; background: white; border-radius: 16px; border: 2px dashed #E5E7EB;">
                <i class="fa-solid fa-mug-hot" style="font-size: 3rem; margin-bottom: 20px; color: #E0E7FF;"></i>
                <h3 style="color: #374151; margin-bottom: 8px;">All caught up!</h3>
                <p style="font-size: 0.95rem;">You have no active tasks. Upload a syllabus to start.</p>
                <button class="btn-primary" onclick="switchTab('upload')" style="margin-top:15px; padding: 10px 20px;">Get Started</button>
            </div>`;
        } else {
            activeList.innerHTML = active.map(t => generateTaskHTML(t, false)).join('');
        }

        if (completed.length === 0) {
            completedList.innerHTML = `<div style="color:#9CA3AF; padding: 20px;">No completed tasks yet.</div>`;
        } else {
            completedList.innerHTML = completed.map(t => generateTaskHTML(t, true)).join('');
        }
    }

    window.deleteTask = async function(taskId) {
        const result = await Swal.fire({
            title: 'Delete Task?', text: "You cannot undo this.", icon: 'warning',
            showCancelButton: true, confirmButtonColor: '#EF4444', confirmButtonText: 'Delete'
        });
        if (result.isConfirmed) {
            await deleteDoc(doc(db, "tasks", taskId));
            loadTasksFromFirestore();
        }
    }

    window.markAsDone = async function(taskId) {
        await updateDoc(doc(db, "tasks", taskId), { completed: true });
        loadTasksFromFirestore();
        showToast("Task completed ‚úÖ");
    }

    window.openEditModal = (taskId) => {
        const task = globalTasks.find(t => t.id === taskId);
        if(!task) return;
        editingTaskId = taskId;
        document.getElementById('editTitle').value = task.title;
        document.getElementById('editSubject').value = task.subject;
        document.getElementById('editDate').value = task.date;
        document.getElementById('editPriority').value = task.priority;
        document.getElementById('editModal').style.display = 'flex';
    }
    window.closeEditModal = () => { document.getElementById('editModal').style.display = 'none'; editingTaskId = null; }

       // --- TASK: VIEW AI-CLEANED MATERIAL ---
    window.openMaterialModal = async (taskId) => {
        const task = globalTasks.find(t => t.id === taskId);
        if (!task) return;
        
        const contentDiv = document.getElementById('materialContent');
        document.getElementById('materialModal').style.display = 'flex';

        // 1. If we already cleaned it before, load it instantly!
        if (task.cleanNotes) {
            contentDiv.innerHTML = task.cleanNotes;
            return;
        }

        // 2. If it's raw text, let's make the AI clean it up
        if (task.originalText && task.originalText.trim() !== "") {
            // Show a nice loading spinner while the AI works
            contentDiv.innerHTML = `
                <div style="text-align:center; padding: 40px;">
                    <div class="spinner" style="margin: 0 auto 15px; border-top-color: #4F46E5;"></div>
                    <h3 style="color: #4F46E5;">‚ú® AI is structuring your notes...</h3>
                    <p style="color: #6B7280; font-size: 0.9rem;">This will only take a few seconds.</p>
                </div>`;

            try {
                // Tell the AI to make it look beautiful
                const prompt = `You are a study assistant. Convert this raw extracted text into clean, highly structured, and easy-to-read study notes. Use HTML formatting (use <h3> for headings, <ul> and <li> for bullet points, <strong> for key terms). DO NOT use markdown backticks like \`\`\`html. Output pure HTML. Raw Text: ${task.originalText.substring(0, 8000)}`;

                const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${GEMINI_API_KEY}`;
                
                const res = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });

                const data = await res.json();
                if (!res.ok) throw new Error("Google API Error");

                // Clean up the AI's response to ensure it's pure HTML
                let cleanHTML = data.candidates[0].content.parts[0].text.replace(/```html|```/g, '').trim();

                // 3. Save it to Firestore so we never have to generate it again!
                await updateDoc(doc(db, "tasks", taskId), { cleanNotes: cleanHTML });
                
                // Update the local array
                task.cleanNotes = cleanHTML;
                
                // Show it to the user
                contentDiv.innerHTML = cleanHTML;

            } catch (err) {
                console.error("AI Notes Error:", err);
                // Fallback: If the AI fails, just show the raw text safely
                contentDiv.innerHTML = `<div style="color: #EF4444; margin-bottom: 10px;">‚ö†Ô∏è AI formatting failed. Showing raw text:</div><div style="white-space: pre-wrap;">${task.originalText}</div>`;
            }
        } else {
            contentDiv.innerHTML = `<div style="text-align:center; color:#9CA3AF; margin-top:40px;"><i class="fa-solid fa-file-circle-xmark" style="font-size: 3rem; margin-bottom: 15px;"></i><br><h3>No material text found</h3><p>Upload a syllabus to get started.</p></div>`;
        }
    };

    window.closeMaterialModal = () => {
        document.getElementById('materialModal').style.display = 'none';
    };

    window.saveEditTask = async () => {
        if(!editingTaskId) return;
        const data = {
            title: document.getElementById('editTitle').value,
            subject: document.getElementById('editSubject').value,
            date: document.getElementById('editDate').value,
            priority: document.getElementById('editPriority').value
        };
        await updateDoc(doc(db, "tasks", editingTaskId), data);
        closeEditModal();
        loadTasksFromFirestore();
    }

    function generateTaskHTML(t, isDone) {
        const cardClass = isDone ? `task-card completed-card` : `task-card ${t.priority}`;
        const cleanDate = t.date ? t.date.replace(/-/g, '') : '';
        const calUrl = `https://calendar.google.com/calendar/render?action=TEMPLATE&text=${encodeURIComponent(t.title)}&dates=${cleanDate}/${cleanDate}`;
        const searchQuery = encodeURIComponent(`${t.subject} ${t.title}`);
        const googleUrl = `https://www.google.com/search?q=${searchQuery}`;
        const ytUrl = `https://www.youtube.com/results?search_query=${searchQuery}`;

        const actionButtons = isDone ?
            `<button class="delete-btn-inline" onclick="deleteTask('${t.id}')"><i class="fa-solid fa-trash"></i></button>` :
            `<a href="${calUrl}" target="_blank" class="calendar-btn"><i class="fa-solid fa-calendar-plus"></i> Calendar</a>
             <button class="check-btn-inline" onclick="markAsDone('${t.id}')"><i class="fa-solid fa-check"></i></button>
             <button class="delete-btn-inline" onclick="deleteTask('${t.id}')"><i class="fa-solid fa-trash"></i></button>`;

        return `
        <div class="${cardClass}">
            ${!isDone ? `<button class="edit-btn-corner" onclick="openEditModal('${t.id}')"><i class="fa-solid fa-pencil"></i></button>` : ''}
            <div class="task-content">
                <div class="task-title">${t.title}</div>
                <div class="task-subject"><i class="fa-solid fa-book"></i> ${t.subject}</div>
                <div class="task-date"><i class="fa-regular fa-clock"></i> ${isDone ? "Completed" : t.date}</div>
                ${!isDone ? `<div class="smart-links">
                    <button onclick="openMaterialModal('${t.id}')" style="flex:1; background:#F3F4F6; color:#374151; padding:8px; border-radius:6px; font-size:0.8rem; border:none; cursor:pointer; transition: 0.2s;"><i class="fa-solid fa-file-lines"></i> Notes</button>
                    <a href="${googleUrl}" target="_blank" style="text-decoration:none; flex:1; background:#EFF6FF; color:#1D4ED8; padding:8px; border-radius:6px; font-size:0.8rem; text-align:center;"><i class="fa-brands fa-google"></i> Search</a>
                    <a href="${ytUrl}" target="_blank" style="text-decoration:none; flex:1; background:#FEF2F2; color:#B91C1C; padding:8px; border-radius:6px; font-size:0.8rem; text-align:center;"><i class="fa-brands fa-youtube"></i> Video</a>
                </div>` : ''}
            </div>
            <div class="card-actions">${actionButtons}</div>
        </div>`;
    }

    function resetUpload() {
        document.querySelector('.upload-zone').style.display = 'block';
        document.querySelector('.upload-zone h3').innerText = "Drag & Drop your Syllabus here";
        document.getElementById('processBtn').style.display = 'none';
    }

    function showToast(message, type = "success") {
        const toast = document.getElementById("toast");
        toast.textContent = (type === "error" ? "‚ùå " : "‚úÖ ") + message;
        toast.className = `toast show`;
        setTimeout(() => toast.classList.remove("show"), 3000);
    }

    // --- TASK: MOBILE RESPONSIVENESS JS ---
    window.toggleSidebar = () => {
        document.querySelector('.sidebar').classList.toggle('open');
    }

    // --- TASK: POMODORO TIMER JS ---
    let timerInterval;
    let timeLeft = 25 * 60;
    let isBreak = false;

    window.startTimer = () => {
        if (timerInterval) return;
        timerInterval = setInterval(() => {
            timeLeft--;
            updateTimerDisplay();
            if (timeLeft <= 0) {
                clearInterval(timerInterval);
                timerInterval = null;
                isBreak = !isBreak;
                timeLeft = isBreak ? 5 * 60 : 25 * 60;
                Swal.fire(isBreak ? 'Break Time!' : 'Work Time!', isBreak ? 'Take 5 minutes.' : 'Let\'s focus.', 'info');
                updateTimerDisplay();
            }
        }, 1000);
    }

    window.pauseTimer = () => {
        clearInterval(timerInterval);
        timerInterval = null;
    }

    window.resetTimer = () => {
        pauseTimer();
        isBreak = false;
        timeLeft = 25 * 60;
        updateTimerDisplay();
    }

    function updateTimerDisplay() {
        const mins = Math.floor(timeLeft / 60);
        const secs = timeLeft % 60;
        document.getElementById('timer-display').innerText = `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
    }

    // --- STUDY MODE (QUIZ) LOGIC ---
    let quizData = [];
    let currentQuestionIndex = 0;
    let quizScore = 0;

    window.openQuiz = () => { document.getElementById('quizModal').style.display = 'flex'; resetQuizMenu(); };
    window.closeQuiz = () => { document.getElementById('quizModal').style.display = 'none'; };

    window.resetQuizMenu = () => {
        document.getElementById('quizLoader').style.display = 'none';
        document.getElementById('quiz-options').style.display = 'grid';
        document.getElementById('quiz-question').innerText = "Choose how you want to study:";
        document.getElementById('quiz-options').innerHTML = `
            <button class="quiz-btn q-blue" onclick="startQuickQuiz()">Quick Quiz (Tasks)</button>
            <button class="quiz-btn q-green" onclick="document.getElementById('materialInput').click()">Upload Materials</button>
        `;
    };

    window.startQuickQuiz = async () => {
        if (globalTasks.length === 0) {
            document.getElementById('quiz-question').innerText = "No tasks found! Upload a syllabus first.";
            return;
        }
        document.getElementById('quiz-options').style.display = 'none';
        document.getElementById('quizLoader').style.display = 'block';

        try {
            const recentTask = [...globalTasks].reverse().find(t => t.originalText);
            const contextText = recentTask ? recentTask.originalText : "";
            const topics = globalTasks.map(t => `${t.subject}: ${t.title}`).join(", ");
            
            const prompt = contextText 
                ? `Based strictly on this material: ${contextText.substring(0, 10000)}. Create a 3-question multiple-choice quiz. Return ONLY JSON format: [{"question": "...", "options": ["A", "B", "C", "D"], "answer": "..."}]`
                : `Create a 3-question multiple-choice quiz on these topics: ${topics}. Return ONLY JSON format: [{"question": "...", "options": ["A", "B", "C", "D"], "answer": "..."}]`;
            
            await generateAndStartQuiz(prompt);
        } catch (err) { console.error(err); resetQuizMenu(); }
    };

    window.handleMaterialUpload = async () => {
        const fileInput = document.getElementById('materialInput');
        if (fileInput.files.length === 0) return;
        document.getElementById('quiz-options').style.display = 'none';
        document.getElementById('quizLoader').style.display = 'block';

        try {
            const file = fileInput.files[0];
            let text = "";
            if (file.name.endsWith('.pdf')) text = await extractTextFromPDF(file);
            else if (file.name.endsWith('.docx')) text = await extractTextFromWord(file);
            else text = await extractTextFromPPTX(file);

            const prompt = `Based on: ${text.substring(0, 8000)}. Create 3 quiz questions. JSON format: [{"question": "...", "options": ["A", "B", "C", "D"], "answer": "..."}]`;
            await generateAndStartQuiz(prompt);
        } catch (err) { console.error(err); resetQuizMenu(); }
    };

    async function generateAndStartQuiz(prompt) {
        const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${GEMINI_API_KEY}`;
        const res = await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
        });
        const data = await res.json();
        const raw = data.candidates[0].content.parts[0].text;
        quizData = JSON.parse(raw.match(/\[[\s\S]*\]/)[0]);
        currentQuestionIndex = 0;
        quizScore = 0;
        document.getElementById('quizLoader').style.display = 'none';
        document.getElementById('quiz-options').style.display = 'grid';
        renderQuizQuestion();
    }

    window.renderQuizQuestion = () => {
        if (currentQuestionIndex >= quizData.length) {
            document.getElementById('quiz-question').innerText = `Finished! Score: ${quizScore}/${quizData.length}`;
            document.getElementById('quiz-options').innerHTML = `<button class="quiz-btn q-blue" onclick="resetQuizMenu()">Play Again</button>`;
            return;
        }
        const q = quizData[currentQuestionIndex];
        document.getElementById('quiz-question').innerText = q.question;
        const colors = ['q-red', 'q-blue', 'q-yellow', 'q-green'];
        document.getElementById('quiz-options').innerHTML = q.options.map((opt, i) =>
            `<button class="quiz-btn ${colors[i]}" onclick="checkAnswer('${opt.replace(/'/g, "\\'")}')">${opt}</button>`
        ).join('');
    };

    window.checkAnswer = (selected) => {
        window.checkAnswer = (selected) => {
        const modalContent = document.querySelector('.quiz-content');
        
        if (selected === quizData[currentQuestionIndex].answer) { 
            quizScore++; 
            modalContent.classList.add('flash-correct'); // Green Flash
            showToast("Correct! üî•", "success");
        } else { 
            modalContent.classList.add('flash-wrong');   // Red Flash
            showToast(`Wrong! Answer: ${quizData[currentQuestionIndex].answer}`, "error");
        }

        setTimeout(() => {
            modalContent.classList.remove('flash-correct', 'flash-wrong');
            currentQuestionIndex++;
            renderQuizQuestion();
        }, 1200);
    };
    };
</script>
</body>
</html>